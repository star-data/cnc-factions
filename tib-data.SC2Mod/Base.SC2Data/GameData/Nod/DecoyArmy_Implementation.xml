<Catalog>
    <!-- ========================================
         NOD DECOY ARMY ABILITY IMPLEMENTATION
         Based on Allied Chronosphere pattern
         ======================================== -->

    <!-- STEP 1: Create the Decoy Unit Template -->
    <CUnit id="NodDecoyUnit" parent="NodInfantry">
        <Race value="Nod"/>
        <FlagArray index="Undetectable" value="0"/>
        <FlagArray index="Invulnerable" value="0"/>
        <FlagArray index="ClearRallyOnTargetLost" value="0"/>
        <Sight value="11"/>
        <!-- Decoys have normal sight range to reveal fog -->
        <BehaviorArray Link="NodDecoyBehavior"/>
        <BehaviorArray Link="NodDecoyTimedLife"/>
        <!-- This unit will be created as a copy of the selected units -->
        <EditorCategories value="ObjectType:Unit,ObjectFamily:Nod"/>
    </CUnit>

    <!-- STEP 2: Decoy Behavior - Makes units hallucinations that die instantly when hit -->
    <CBehaviorBuff id="NodDecoyBehavior">
        <InfoIcon value="Assets\Textures\btn-ability-protoss-hallucination.dds"/>
        <EditorCategories value="AbilityorEffectType:Units"/>
        <DisplayDuration index="Self" value="1"/>
        <Duration value="60"/>
        <!-- 60 seconds lifetime -->
        <Modification>
            <StateFlags index="Hallucination" value="1"/>
            <!-- Mark as hallucination -->
            <ModifyFlags index="RevealUnit" value="1"/>
            <!-- Reveals fog of war -->
        </Modification>
        <DamageResponse ModifyFraction="0">
            <!-- Takes no damage but triggers instant death -->
            <Chance value="1"/>
            <KillUnit value="1"/>
            <!-- Dies instantly when hit -->
        </DamageResponse>
    </CBehaviorBuff>

    <!-- STEP 3: Timed Life for Decoys (60 seconds) -->
    <CBehaviorBuff id="NodDecoyTimedLife" parent="TimedLife">
        <EditorCategories value="AbilityorEffectType:Units"/>
        <Duration value="60"/>
        <!-- Auto-vaporize after 60 seconds -->
        <BuffFlags index="Countdown" value="1"/>
    </CBehaviorBuff>

    <!-- STEP 4: Main Targeting Ability (First Click - Select Source Units) -->
    <CAbilEffectTarget id="NodDecoyArmyTargeting">
        <EditorCategories value="Race:Nod,AbilityorEffectType:Units"/>
        <Effect index="0" value="NodDecoyArmyTestNullEffect"/>
        <Cost>
            <Charge Link="Abil/NovaNuclearStrike"/>
            <Cooldown Link="NodDecoyArmyCooldown" TimeStart="120" TimeUse="120"/>
        </Cost>
        <Range value="500"/>
        <Arc value="360"/>
        <Marker Link="Abil/NovaNuclearStrike"/>
        <AlertArray index="Cast" value="CalldownLaunch"/>
        <CursorEffect value="NodDecoyArmySearchForUnits"/>
        <CmdButtonArray index="Execute" DefaultButtonFace="NodDecoyArmyButton" Requirements="NodDecoyArmyRequirement"/>
        <CmdButtonArray index="Cancel" DefaultButtonFace="Cancel3"/>
    </CAbilEffectTarget>

    <!-- STEP 5: Second Stage Ability (Second Click - Select Destination) -->
    <CAbilEffectTarget id="NodDecoyArmy_Execute">
        <EditorCategories value="Race:Nod,AbilityorEffectType:Units"/>
        <Effect index="0" value="NodDecoyArmyExecuteEffect"/>
        <Cost>
            <Charge Link="Abil/NovaNuclearStrike"/>
            <Cooldown Link="NodDecoyArmyCooldown" TimeUse="120"/>
        </Cost>
        <Range value="500"/>
        <Arc value="360"/>
        <Marker Link="Abil/NovaNuclearStrike"/>
        <AlertArray index="Cast" value="CalldownLaunch"/>
        <CursorEffect value="NodDecoyArmySearchForUnits"/>
        <CmdButtonArray index="Execute" DefaultButtonFace="NodDecoyArmyButton"/>
        <CmdButtonArray index="Cancel" DefaultButtonFace="Cancel32"/>
    </CAbilEffectTarget>

    <!-- STEP 6: Marker Unit (placed at source location) -->
    <CUnit id="NodDecoyArmyMarker">
        <Race value="Nod"/>
        <FlagArray index="Undetectable" value="1"/>
        <FlagArray index="Invulnerable" value="1"/>
        <FlagArray index="ClearRallyOnTargetLost" value="0"/>
        <Sight value="4"/>
        <AbilArray Link="NodDecoyArmy_Execute"/>
        <BehaviorArray Link="NodDecoyMarkerBehavior"/>
        <BehaviorArray Link="NodDecoyMarkerTimedLife"/>
        <CardLayouts>
            <LayoutButtons Face="NodDecoyArmyButton" Type="AbilCmd" AbilCmd="NodDecoyArmy_Execute,Execute" Row="0" Column="0"/>
            <LayoutButtons Face="Cancel32" Type="AbilCmd" AbilCmd="NodDecoyArmy_Execute,Cancel" Row="2" Column="4"/>
        </CardLayouts>
        <EditorCategories value="ObjectType:Other,ObjectFamily:Nod"/>
    </CUnit>

    <!-- STEP 7: Marker Behavior - Periodically clones units -->
    <CBehaviorBuff id="NodDecoyMarkerBehavior">
        <EditorCategories value="AbilityorEffectType:Units"/>
        <Period value="0.1"/>
        <InitialEffect value="NodDecoyCloneUnitsInArea"/>
        <PeriodicEffect value="NodDecoyCloneUnitsInArea"/>
    </CBehaviorBuff>

    <!-- STEP 8: Marker Timed Life -->
    <CBehaviorBuff id="NodDecoyMarkerTimedLife" parent="TimedLife">
        <EditorCategories value="AbilityorEffectType:Units"/>
        <Duration value="70"/>
        <BuffFlags index="Countdown" value="0"/>
    </CBehaviorBuff>

    <!-- STEP 9: Effect to create marker at source location -->
    <CEffectSet id="NodDecoyArmyTestNullEffect">
        <TargetLocationType value="Point"/>
        <EffectArray value="NodDecoyArmyTestEmptyEffectStarts"/>
        <EffectArray value="NodDecoyArmyCooldownStart"/>
    </CEffectSet>

    <CEffectSet id="NodDecoyArmyTestEmptyEffectStarts">
        <TargetLocationType value="Unknown"/>
    </CEffectSet>

    <!-- STEP 10: Cooldown management -->
    <CEffectApplyBehavior id="NodDecoyArmyCooldownStart">
        <WhichUnit Value="Caster"/>
        <Behavior value="NodDecoyArmyCooldownBehavior"/>
    </CEffectApplyBehavior>

    <CBehaviorBuff id="NodDecoyArmyCooldownBehavior">
        <EditorCategories value="AbilityorEffectType:Units"/>
        <BuffFlags index="DisableWhileUnderConstruction" value="1"/>
        <Duration value="120"/>
        <InfoFlags index="Hidden" value="1"/>
    </CBehaviorBuff>

    <!-- STEP 11: Execute Effect - Creates marker and clones units -->
    <CEffectCreatePersistent id="NodDecoyArmyExecuteEffect">
        <InitialEffect value="NodDecoyArmyEffectCollection"/>
        <PeriodCount value="1"/>
        <PeriodicPeriodArray value="0.1"/>
        <RevealRadius value="6"/>
        <RevealFlags index="Unfog" value="1"/>
    </CEffectCreatePersistent>

    <CEffectSet id="NodDecoyArmyEffectCollection">
        <EffectArray value="NodDecoyCreateMarker"/>
        <EffectArray value="NodDecoyCloneUnitsInArea"/>
        <TargetLocationType value="Unknown"/>
    </CEffectSet>

    <!-- STEP 12: Create marker unit -->
    <CEffectCreateUnit id="NodDecoyCreateMarker">
        <WhichLocation Value="TargetPoint"/>
        <SpawnUnit value="NodDecoyArmyMarker"/>
    </CEffectCreateUnit>

    <!-- STEP 13: Clone units in area -->
    <CEffectEnumArea id="NodDecoyCloneUnitsInArea">
        <LunchLocation Value="CasterPoint"/>
        <ImpactLocation Value="CasterPoint"/>
        <SearchFilters value="Ground;Neutral,Air,Structure,Missile"/>
        <AreaArray Radius="3.5" Effect="NodDecoyCloneSingleUnit"/>
    </CEffectEnumArea>

    <!-- STEP 14: Search for units at destination -->
    <CEffectEnumArea id="NodDecoyArmySearchForUnits">
        <LaunchLocation Value="TargetPoint"/>
        <ImpactLocation Value="CasterPoint"/>
        <SearchFilters value="Ground;Neutral,Air,Structure"/>
        <AreaArray Radius="3.5" Effect="NodDecoyTeleportUnit"/>
    </CEffectEnumArea>

    <!-- STEP 15: Clone individual unit effect -->
    <CEffectCreateUnit id="NodDecoyCloneSingleUnit">
        <WhichLocation Value="TargetPoint"/>
        <!-- This needs to be enhanced with triggers to copy unit type -->
        <SpawnUnit value="NodDecoyUnit"/>
        <SpawnCount value="1"/>
        <SpawnEffect value="NodDecoyApplyBehavior"/>
    </CEffectCreateUnit>

    <!-- STEP 16: Apply decoy behavior to cloned unit -->
    <CEffectApplyBehavior id="NodDecoyApplyBehavior">
        <Behavior value="NodDecoyBehavior"/>
    </CEffectApplyBehavior>

    <!-- STEP 17: Teleport effect (for moving decoys to destination) -->
    <CEffectTeleport id="NodDecoyTeleportUnit">
        <PlacementAround Effect="NodDecoyArmySearchForUnits"/>
        <TargetLocation Effect="NodDecoyArmySearchForUnits" Value="TargetPoint"/>
        <PlacementRange value="10"/>
        <SourceLocation Effect="NodDecoyArmySearchForUnits" Value="CasterPoint"/>
        <TeleportFlags index="TestFog" value="0"/>
        <TeleportEffect value="NodDecoyApplyBehavior"/>
    </CEffectTeleport>

    <!-- STEP 18: Actor for marker unit -->
    <CActorUnit id="NodDecoyArmyMarker" parent="GenericUnitStandard" unitName="NodDecoyArmyMarker">
        <Scale value="0.650000"/>
        <HighlightTooltip value="Unit/Name/NodDecoyArmyMarker"/>
        <On Terms="ActorCreation" Send="AnimBracketStart Birth Stand"/>
    </CActorUnit>

    <!-- STEP 19: Model for marker -->
    <CModel id="NodDecoyArmyMarker" Race="Nod">
        <Model value="Assets\Effects\Protoss\TimeBomb\TimeBomb.m3"/>
        <EditorCategories value="Race:Nod"/>
        <Flags index="TeenSafe" value="1"/>
        <SelectionRadius value="1.000000"/>
        <ShadowRadius value="0.000000"/>
    </CModel>

    <!-- STEP 20: Button for ability -->
    <CButton id="NodDecoyArmyButton">
        <Name value="Button/Name/NodDecoyArmy"/>
        <Tooltip value="Button/Tooltip/NodDecoyArmy"/>
        <Icon value="Assets\Textures\btn-ability-protoss-hallucination.dds"/>
    </CButton>

    <!-- STEP 21: Cooldown link -->
    <CCooldown id="NodDecoyArmyCooldown">
        <TimeStart value="120"/>
        <TimeUse value="120"/>
    </CCooldown>

    <!-- STEP 22: Requirement (optional - for tech tree) -->
    <CRequirement id="NodDecoyArmyRequirement">
        <CountUnit index="0" value="1"/>
        <CountUnitUnit index="0" value="NodTechCenter"/>
    </CRequirement>

</Catalog>
